(()=>{"use strict";const e=window.React,{__:t}=wp.i18n,{useMemo:n}=wp.element,{Button:i,Tooltip:o}=wp.components,{useActionsEdit:r}=JetFBHooks,{ActionsAfterNewButtonSlotFill:l}=JetFBComponents,{Tools:a}=JetFBActions,c=()=>({id:a.getRandomID(),type:"verification",settings:{}}),s={base:{jfbApiVersion:2,name:"jf-verification"},settings:{render:function(){const{actions:a,setActions:s}=r(),u=n(c,[]),m=a.some((({type:e})=>"verification"===e));return(0,e.createElement)(l.Fill,null,(0,e.createElement)(o,{text:t(m?"You have already added the Verification action":"Click here to add Verification action","jet-form-builder"),delay:200,position:"top center"},(0,e.createElement)(i,{onClick:()=>{s([{...u},...a])},disabled:m,variant:"tertiary"},t("+ Verification","jet-form-builder"))))},icon:"filter"}},{useLoopedAction:u}=JetFBHooks,{EditActionSettingsButton:m,ActionItemWrapper:d,ActionTitle:f,ActionItemMoreButton:p}=JetFBComponents,{Flex:h,CardBody:g}=wp.components,{select:v,dispatch:b}=wp.data;let E;const w=()=>{const e=v("core/editor").getEditedPostAttribute("meta")||{};if(E===e._jf_actions||"string"!=typeof e._jf_actions)return;E=e._jf_actions;const t=JSON.parse(E),n=t.findIndex((({type:e})=>"verification"===e)),i=-1!==n,o=v("jet-forms/actions").getAction("verification");if(0<n&&i){const i=t[n];t.splice(n,1),b("core/editor").editPost({meta:{...e,_jf_actions:JSON.stringify([i,...t])}})}o.disabled!==i&&b("jet-forms/actions").editAction("verification",{disabled:i})},_="VERIFICATION.SUCCESS",y="VERIFICATION.FAILED",j="_jfb_verification_token",{BaseComputedField:C}=JetFBComponents,{sprintf:F,__:A}=wp.i18n;function S(){C.call(this),this.getSupportedActions=function(){return["register_user"]}}S.prototype=Object.create(C.prototype),S.prototype.getName=function(){return j},S.prototype.getLabel=function(){return A("Secure unique token","jet-form-builder")},S.prototype.getHelp=function(){return A("A computed field. Usually used to save it in the password fields","jet-form-builder")};const B=S;function k(){B.call(this),this.isSupported=function(e){var t;return"verification"===e.type&&!e.selfSettings.who_can||"register_user"===e.type&&Object.values(null!==(t=e.selfSettings.fields_map)&&void 0!==t?t:{}).includes(j)}}k.prototype=Object.create(B.prototype);const x=k,{BaseComputedField:I}=JetFBComponents,{sprintf:T,__:O}=wp.i18n;function V(){I.call(this),this.getSupportedActions=function(){return["verification"]}}V.prototype=Object.create(I.prototype),V.prototype.getName=function(){return"_jfb_verification_token_id"},V.prototype.getLabel=function(){return O("ID of secure unique token","jet-form-builder")},V.prototype.getHelp=function(){return O("A computed field from the Verification action.","jet-form-builder")};const L=V,{BaseComputedField:J}=JetFBComponents,{__:R}=wp.i18n;function N(){J.call(this),this.isSupported=function(e){return"verification"===e.type&&!e.selfSettings.who_can}}N.prototype=Object.create(J.prototype),N.prototype.getName=function(){return"_jfb_verification_url"},N.prototype.getLabel=function(){return R("Verification URL","jet-form-builder")},N.prototype.getHelp=function(){return R("A computed field from the Verification action. \nUsually used to send it using the Send by Email action.","jet-form-builder")};const H=N,{useLoopedAction:P,useActionsEdit:M,useActions:D,useEvents:U}=JetFBHooks,{EditActionSettingsButton:z,EditActionConditionsButton:G,ActionItemWrapper:Z,ActionTitle:q,ActionItemMoreButton:W,ActionItemDetails:Y}=JetFBComponents,{Flex:Q,CardBody:K,CardFooter:X,Button:$}=wp.components,{__:ee}=wp.i18n,te=window.wp.hooks,ne=window.wp.data,{__:ie}=wp.i18n,oe=function(){return(0,e.createElement)(e.Fragment,null,(0,e.createElement)("h3",{style:{marginTop:0}},ie("Here is a brief description of how this verification action works:","jet-form-builder")),(0,e.createElement)("p",null,ie("1. The user sends the form for the first time. \nOn this stage, all actions that having the","jet-form-builder")+" ",(0,e.createElement)("code",null,"DEFAULT.PROCESS")," "+ie("event are executed. \nAfter that, Save Record action is executed, even if it is not present \nin the list of actions. At the same time, a unique token in a hashed \nform is stored in a separate table in the database.","jet-form-builder")),(0,e.createElement)("p",null,ie("2. The user receives an email containing a link to your \nsite with a key to the previously saved token. This can be achieved by sending \na letter to e-mail.","jet-form-builder")),(0,e.createElement)("p",null,ie("3. After clicking the link, the plugin checks the key with \nthe token. If the result is positive, the actions with either no events \nor with the","jet-form-builder")+" ",(0,e.createElement)("code",null,"VERIFICATION.SUCCESS")," "+ie("event are executed. If the result is negative, only actions with the","jet-form-builder")+" ",(0,e.createElement)("code",null,"VERIFICATION.FAILED")," "+ie("event will run.","jet-form-builder")))},{apiFetch:re}=wp,le=async function(e){return(await re(e)).map((({title:e,id:t})=>({value:t,label:e.rendered})))},{addQueryArgs:ae}=wp.url,{useState:ce,useEffect:se}=wp.element,ue=function(e=[]){const[t,n]=ce([]),[i,o]=ce("");return se((()=>{var t;i?le({path:(t=i,ae("/wp/v2/pages",{search:t}))}).then(n):n(e)}),[i,e.length]),[t,o]},me=JSON.parse('[{"type":"send_email","settings":{"mail_to":"form","from_field":"_verify_user_email","subject":"[%CT::SiteName%] Confirm your email","content":"Please confirm your registration on site %CT::SiteName%.\\n\\n<b>If this was a mistake, ignore this email and nothing will happen.</b>\\n\\nTo complete the registration click on the link:\\n%_jfb_verification_url%"},"events":["DEFAULT.PROCESS"]}]');let{__experimentalToggleGroupControl:de,__experimentalToggleGroupControlOption:fe,ToggleGroupControl:pe,ToggleGroupControlOption:he,BaseControl:ge,ComboboxControl:ve,Button:be,Flex:Ee,SelectControl:we}=wp.components;pe=pe||de,he=he||fe;const{__:_e}=wp.i18n,{useState:ye,useEffect:je,useMemo:Ce}=wp.element,{addQueryArgs:Fe}=wp.url,{useDispatch:Ae}=wp.data,{BaseHelp:Se,BaseAction:Be,ToggleControl:ke}=JetFBComponents,{useActions:xe,useFields:Ie,useCurrentAction:Te}=JetFBHooks,{Tools:Oe,convertFlow:Ve}=JetFBActions,Le=Ve(me),Je=(e,t)=>{const n=new Set(e.map((({value:e})=>e))),i=[];for(const e of t)n.has(e.value)||i.push(e);return[...e,...i]},Re=function({onChangeSettingObj:t,settings:n}){var i,o;const[r,l]=xe([]),a=Ie({withInner:!1},[]),{currentAction:c}=Te(),s=Ce((()=>a.find((e=>"email"===e?.attributes?.field_type))),[]),[u,m]=ye(Boolean(n.mail_to)),d=Ce((()=>r.findIndex((({events:e=[],type:t})=>-1!==e.indexOf(_)&&"redirect_to_page"===t))),[]),f=Ce((()=>r.findIndex((({events:e=[],type:t})=>-1!==e.indexOf(y)&&"redirect_to_page"===t))),[]),p=null!==(i=r[d])&&void 0!==i?i:{},h=null!==(o=r[f])&&void 0!==o?o:{},[g,v]=ye([]),[b,E]=ue(g),[w,j]=ue(g),{openActionSettings:C}=Ae("jet-forms/actions"),F=(e,t)=>{const n=new Be({type:"redirect_to_page"});return n.events=[t],e&&(n.selfSettings={redirect_type:"static_page",redirect_page:e}),l([...r.map((e=>c.id!==e.id?e:c)),n]),n};return je((()=>{le({path:"/wp/v2/pages"}).then((e=>v((t=>Je(t,e)))));const e=[n.success_page,n.failed_page].filter(Boolean);e.length&&le({path:Fe("/wp/v2/pages",{include:e})}).then((e=>v((t=>Je(t,e)))))}),[]),"admin"===n.who_can?null:(0,e.createElement)(e.Fragment,null,(0,e.createElement)(ge,{label:_e("Email Field","jet-form-builder"),className:"jet-fb label-reset-margin"},(0,e.createElement)("div",{className:"jet-control-clear-full"},(0,e.createElement)(we,{value:n.mail_to,onChange:e=>t({mail_to:e}),options:Oe.withPlaceholder(a),hideLabelFromVision:!0}),(0,e.createElement)(Se,null,_e("Send a verification link to the email address \nprovided in this field.","jet-form-builder")),!u&&Boolean(s)&&(0,e.createElement)(Se,null,(0,e.createElement)(Ee,{justify:"flex-start",gap:1},_e("(Suggestion) Choose the:","jet-form-builder"),(0,e.createElement)(be,{isLink:!0,onClick:()=>{m(!0),t({mail_to:s.value})}},s.label),_e("field","jet-form-builder"))))),n.mail_to&&(0,e.createElement)(ke,{checked:Boolean(n.custom_email),onChange:e=>t({custom_email:e}),help:_e("If disabled, a standard verification email will be sent. \nIf enabled, you can create a custom verification email \nwith a separate Send Email action.","jet-form-builder")},(0,e.createElement)(Ee,{gap:3,justify:"flex-start"},_e("Create custom verification email","jet-form-builder"),n.custom_email&&(0,e.createElement)(be,{isLink:!0,onClick:()=>{const e=(()=>{const{list:[e]}=Le;return e.selfSettings={...e.selfSettings,from_field:n.mail_to},l([...r.map((e=>c.id!==e.id?e:c)),{...e}]),e})();C({index:r.length,item:e})}},_e("+ Add Send Email action","jet-form-builder")))),(0,e.createElement)(ge,{label:_e("Success Page","jet-form-builder"),className:"control-flex"},(0,e.createElement)(Ee,{style:{flex:3.1},direction:"column"},-1!==d?(0,e.createElement)(e.Fragment,null,(0,e.createElement)(Se,null,_e("You have already configured the \nRedirect to Page action with the event:","jet-form-builder"),(0,e.createElement)("code",null,_)),(0,e.createElement)(Ee,null,(0,e.createElement)(be,{icon:(0,e.createElement)("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",width:"24",height:"24","aria-hidden":"true",focusable:"false"},(0,e.createElement)("path",{d:"m19 7-3-3-8.5 8.5-1 4 4-1L19 7Zm-7 11.5H5V20h7v-1.5Z"})),onClick:()=>{C({index:d,item:p})}},_e("Edit verification success redirect","jet-form-builder")))):(0,e.createElement)(e.Fragment,null,(0,e.createElement)(ve,{value:n.success_page,onChange:e=>t({success_page:e}),options:b,hideLabelFromVision:!0,onFilterValueChange:E}),(0,e.createElement)(Se,{style:{marginTop:"-1em"}},_e("Select a page for the redirect after successful \nverification. By default, the user is redirected to the form page. Or","jet-form-builder"),"Â ",(0,e.createElement)(be,{isLink:!0,onClick:()=>{const e=F(n.success_page,_);C({index:r.length,item:{...e}})}},_e("configure a separate Redirect to Page action","jet-form-builder")))))),(0,e.createElement)(ge,{label:_e("Failed Page","jet-form-builder"),className:"control-flex"},(0,e.createElement)(Ee,{style:{flex:3.1},direction:"column"},-1!==f?(0,e.createElement)(e.Fragment,null,(0,e.createElement)(Se,null,_e("You have already configured the\nRedirect to Page action with the event:","jet-form-builder"),(0,e.createElement)("code",null,y)),(0,e.createElement)(Ee,null,(0,e.createElement)(be,{icon:(0,e.createElement)("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",width:"24",height:"24","aria-hidden":"true",focusable:"false"},(0,e.createElement)("path",{d:"m19 7-3-3-8.5 8.5-1 4 4-1L19 7Zm-7 11.5H5V20h7v-1.5Z"})),onClick:()=>{C({index:f,item:h})}},_e("Edit verification failed redirect","jet-form-builder")))):(0,e.createElement)(e.Fragment,null,(0,e.createElement)(ve,{value:n.failed_page,onChange:e=>t({failed_page:e}),options:w,hideLabelFromVision:!0,onFilterValueChange:j}),(0,e.createElement)(Se,{style:{marginTop:"-1em"}},_e("Select a page for the redirect after verification \nfailure. By default, the user is redirected to the form page. Or","jet-form-builder"),"Â ",(0,e.createElement)(be,{isLink:!0,onClick:()=>{const e=F(n.failed_page,y);C({index:r.length,item:{...e}})}},_e("configure a separate Redirect to Page action","jet-form-builder")))))))},{TextControl:Ne,BaseControl:He,Button:Pe,Flex:Me,SelectControl:De}=wp.components,{__:Ue}=wp.i18n,{useState:ze}=wp.element,{BaseHelp:Ge,ActionModalHeaderSlotFill:Ze}=JetFBComponents,qe=window.wp.i18n,We=window.wp.primitives,Ye=(0,e.createElement)(We.SVG,{viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg"},(0,e.createElement)(We.Path,{d:"M9 13.5a1.5 1.5 0 100-3 1.5 1.5 0 000 3zM9 16a4.002 4.002 0 003.8-2.75H15V16h2.5v-2.75H19v-2.5h-6.2A4.002 4.002 0 005 12a4 4 0 004 4z",fillRule:"evenodd",clipRule:"evenodd"})),Qe={type:"verification",edit:function({onChangeSettingObj:t,settings:n}){var i,o;const[r,l]=ze(!1);return(0,e.createElement)(e.Fragment,null,(0,e.createElement)(Ze.Fill,null,(0,e.createElement)(Me,{gap:1},Ue("Edit Verification action","jet-form-builder"),(0,e.createElement)(Pe,{variant:"tertiary",isPressed:r,icon:(0,e.createElement)("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",width:"24",height:"24","aria-hidden":"true",focusable:"false"},(0,e.createElement)("path",{d:"M12 4.75a7.25 7.25 0 100 14.5 7.25 7.25 0 000-14.5zM3.25 12a8.75 8.75 0 1117.5 0 8.75 8.75 0 01-17.5 0zM12 8.75a1.5 1.5 0 01.167 2.99c-.465.052-.917.44-.917 1.01V14h1.5v-.845A3 3 0 109 10.25h1.5a1.5 1.5 0 011.5-1.5zM11.25 15v1.5h1.5V15h-1.5z"})),onClick:()=>l((e=>!e))}))),r&&(0,e.createElement)(oe,null),(0,e.createElement)(De,{label:Ue("Who can verify the submission","jet-form-builder"),value:null!==(i=n.who_can)&&void 0!==i?i:"",labelPosition:"side",options:[{value:"",label:Ue("User & Administrator","jet-form-builder")},{value:"admin",label:Ue("Administrator","jet-form-builder")}],onChange:e=>t({who_can:e})}),(0,e.createElement)(He,{label:Ue("Link Lifespan","jet-form-builder"),className:"jet-fb label-reset-margin"},(0,e.createElement)("div",{style:{flex:3}},(0,e.createElement)(Ne,{value:null!==(o=n.lifespan)&&void 0!==o?o:4,onChange:e=>t({lifespan:e})}),(0,e.createElement)(Ge,{style:{marginTop:"-4px"}},Ue('Indicates for how many hours a verification link \nwill be active. If you leave this field empty or enter "0", it means \nverification can be completed at any given time.',"jet-form-builder")))),(0,e.createElement)(Re,{settings:n,onChangeSettingObj:t}))},label:(0,qe.__)("Verification","jet-form-builder"),icon:Ye,docHref:"https://jetformbuilder.com/features/email-verification/",provideEvents:()=>[_,y]},{addComputedField:Ke}=JetFBActions;window.JetFBComponents={...window.JetFBComponents,TokenComputedField:B,TokenIDComputedField:L,VerificationURLComputedField:H},Ke(B,{isScoped:!0}),Ke(x),Ke(L),Ke(H),(0,te.addFilter)("jet.fb.register.plugin.jf-actions-panel.before","jet-form-builder/verification",(function(e){return e.push(s),e})),(0,te.addFilter)("jet.fb.action.item","jet-form-builder/verification-action",(t=>()=>{const{action:n}=u();return"verification"!==n.type?(0,e.createElement)(t,null):(0,e.createElement)(d,null,(0,e.createElement)(g,null,(0,e.createElement)(f,null),(0,e.createElement)(h,{style:{marginTop:"0.5em"},justify:"space-between"},(0,e.createElement)(m,null),(0,e.createElement)(p,{exclude:["up","down","off-on"]}))))})),(0,te.addFilter)("jet.fb.action.item","jet-form-builder/footer-notice-for-no-events",(t=>()=>{const{action:n}=P(),{updateActionObj:i}=M(),[o]=D(),r=U(n),l=o.some((e=>"verification"===e.type));return n?.events?.length||"verification"===n.type||!l||1>=r.length?(0,e.createElement)(t,null):(0,e.createElement)(Z,null,(0,e.createElement)(K,null,(0,e.createElement)(q,null),(0,e.createElement)(Q,{style:{marginTop:"0.5em"},justify:"space-between"},(0,e.createElement)(z,null),(0,e.createElement)(G,null),(0,e.createElement)(W,null),(0,e.createElement)(Y,null))),(0,e.createElement)(X,null,(0,e.createElement)(Q,{justify:"flex-start",style:{width:"auto"}},(0,e.createElement)("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"-2 -2 24 24",width:"24",height:"24","aria-hidden":"true",focusable:"false",style:{color:"var( --wp-components-color-accent-darker-10, #9e1313 )"}},(0,e.createElement)("path",{fill:"currentColor",d:"M10 2c4.42 0 8 3.58 8 8s-3.58 8-8 8-8-3.58-8-8 3.58-8 8-8zm1.13 9.38l.35-6.46H8.52l.35 6.46h2.26zm-.09 3.36c.24-.23.37-.55.37-.96 0-.42-.12-.74-.36-.97s-.59-.35-1.06-.35-.82.12-1.07.35-.37.55-.37.97c0 .41.13.73.38.96.26.23.61.34 1.06.34s.8-.11 1.05-.34z"})),ee("Runs on verification","jet-form-builder")),(0,e.createElement)($,{isLink:!0,onClick:()=>i(n.id,{events:["DEFAULT.PROCESS"]}),style:{textDecoration:"none",borderBottom:"2px dotted var(--wp-components-color-accent, var(--wp-admin-theme-color, #3858e9))"}},ee("Run always","jet-form-builder"))))})),(0,ne.subscribe)((()=>setTimeout(w,0))),(0,ne.dispatch)("jet-forms/actions").registerAction(Qe)})();