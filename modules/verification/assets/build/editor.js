(()=>{"use strict";const e=window.React,{__:t}=wp.i18n,{useMemo:n}=wp.element,{Button:i,Tooltip:o}=wp.components,{useActionsEdit:r}=JetFBHooks,{ActionsAfterNewButtonSlotFill:l}=JetFBComponents,{Tools:a}=JetFBActions,c=()=>({id:a.getRandomID(),type:"verification",settings:{}}),s={base:{jfbApiVersion:2,name:"jf-verification"},settings:{render:function(){const{actions:a,setActions:s}=r(),u=n(c,[]),m=a.some((({type:e})=>"verification"===e));return(0,e.createElement)(l.Fill,null,(0,e.createElement)(o,{text:t(m?"You have already added the Verification action":"Click here to add Verification action","jet-form-builder"),delay:200,position:"top center"},(0,e.createElement)(i,{onClick:()=>{s([{...u},...a])},disabled:m,variant:"tertiary"},t("+ Verification","jet-form-builder"))))},icon:"filter"}},{__:u}=wp.i18n,m=function(){return(0,e.createElement)(e.Fragment,null,(0,e.createElement)("h3",{style:{marginTop:0}},u("Here is a brief description of how this verification action works:","jet-form-builder")),(0,e.createElement)("p",null,u("1. The user sends the form for the first time. \nOn this stage, all actions that having the","jet-form-builder")+" ",(0,e.createElement)("code",null,"DEFAULT.PROCESS")," "+u("event are executed. \nAfter that, Save Record action is executed, even if it is not present \nin the list of actions. At the same time, a unique token in a hashed \nform is stored in a separate table in the database.","jet-form-builder")),(0,e.createElement)("p",null,u("2. The user receives an email containing a link to your \nsite with a key to the previously saved token. This can be achieved by sending \na letter to e-mail.","jet-form-builder")),(0,e.createElement)("p",null,u("3. After clicking the link, the plugin checks the key with \nthe token. If the result is positive, the actions with either no events \nor with the","jet-form-builder")+" ",(0,e.createElement)("code",null,"VERIFICATION.SUCCESS")," "+u("event are executed. If the result is negative, only actions with the","jet-form-builder")+" ",(0,e.createElement)("code",null,"VERIFICATION.FAILED")," "+u("event will run.","jet-form-builder")))},d="verification",f="VERIFICATION.SUCCESS",p="VERIFICATION.FAILED",h="_jfb_verification_token",{apiFetch:g}=wp,v=async function(e){return(await g(e)).map((({title:e,id:t})=>({value:t,label:e.rendered})))},{addQueryArgs:E}=wp.url,{useState:b,useEffect:w}=wp.element,y=function(e=[]){const[t,n]=b([]),[i,o]=b("");return w((()=>{var t;i?v({path:(t=i,E("/wp/v2/pages",{search:t}))}).then(n):n(e)}),[i,e.length]),[t,o]},_=JSON.parse('[{"type":"send_email","settings":{"mail_to":"form","from_field":"_verify_user_email","subject":"[%CT::SiteName%] Confirm your email","content":"Please confirm your registration on site %CT::SiteName%.\\n\\n<b>If this was a mistake, ignore this email and nothing will happen.</b>\\n\\nTo complete the registration click on the link:\\n%_jfb_verification_url%"},"events":["DEFAULT.PROCESS"]}]');let{__experimentalToggleGroupControl:j,__experimentalToggleGroupControlOption:C,ToggleGroupControl:F,ToggleGroupControlOption:A,BaseControl:S,ComboboxControl:B,Button:k,Flex:x,SelectControl:I}=wp.components;F=F||j,A=A||C;const{__:T}=wp.i18n,{useState:O,useEffect:L,useMemo:V}=wp.element,{addQueryArgs:J}=wp.url,{useDispatch:N}=wp.data,{BaseHelp:R,BaseAction:P,ToggleControl:H}=JetFBComponents,{useActions:D,useFields:M,useCurrentAction:U}=JetFBHooks,{Tools:z,convertFlow:G}=JetFBActions,Z=G(_),q=(e,t)=>{const n=new Set(e.map((({value:e})=>e))),i=[];for(const e of t)n.has(e.value)||i.push(e);return[...e,...i]},W=function({onChangeSettingObj:t,settings:n}){var i,o;const[r,l]=D([]),a=M({withInner:!1},[]),{currentAction:c}=U(),s=V((()=>a.find((e=>"email"===e?.attributes?.field_type))),[]),[u,m]=O(Boolean(n.mail_to)),d=V((()=>r.findIndex((({events:e=[],type:t})=>-1!==e.indexOf(f)&&"redirect_to_page"===t))),[]),h=V((()=>r.findIndex((({events:e=[],type:t})=>-1!==e.indexOf(p)&&"redirect_to_page"===t))),[]),g=null!==(i=r[d])&&void 0!==i?i:{},E=null!==(o=r[h])&&void 0!==o?o:{},[b,w]=O([]),[_,j]=y(b),[C,F]=y(b),{openActionSettings:A}=N("jet-forms/actions"),G=(e,t)=>{const n=new P({type:"redirect_to_page"});return n.events=[t],e&&(n.selfSettings={redirect_type:"static_page",redirect_page:e}),l([...r.map((e=>c.id!==e.id?e:c)),n]),n};return L((()=>{v({path:"/wp/v2/pages"}).then((e=>w((t=>q(t,e)))));const e=[n.success_page,n.failed_page].filter(Boolean);e.length&&v({path:J("/wp/v2/pages",{include:e})}).then((e=>w((t=>q(t,e)))))}),[]),"admin"===n.who_can?null:(0,e.createElement)(e.Fragment,null,(0,e.createElement)(S,{label:T("Email Field","jet-form-builder"),className:"jet-fb label-reset-margin"},(0,e.createElement)("div",{className:"jet-control-clear-full"},(0,e.createElement)(I,{value:n.mail_to,onChange:e=>t({mail_to:e}),options:z.withPlaceholder(a),hideLabelFromVision:!0}),(0,e.createElement)(R,null,T("Send a verification link to the email address \nprovided in this field.","jet-form-builder")),!u&&Boolean(s)&&(0,e.createElement)(R,null,(0,e.createElement)(x,{justify:"flex-start",gap:1},T("(Suggestion) Choose the:","jet-form-builder"),(0,e.createElement)(k,{isLink:!0,onClick:()=>{m(!0),t({mail_to:s.value})}},s.label),T("field","jet-form-builder"))))),n.mail_to&&(0,e.createElement)(H,{checked:Boolean(n.custom_email),onChange:e=>t({custom_email:e}),help:T("If disabled, a standard verification email will be sent. \nIf enabled, you can create a custom verification email \nwith a separate Send Email action.","jet-form-builder")},(0,e.createElement)(x,{gap:3,justify:"flex-start"},T("Create custom verification email","jet-form-builder"),n.custom_email&&(0,e.createElement)(k,{isLink:!0,onClick:()=>{const e=(()=>{const{list:[e]}=Z;return e.selfSettings={...e.selfSettings,from_field:n.mail_to},l([...r.map((e=>c.id!==e.id?e:c)),{...e}]),e})();A({index:r.length,item:e})}},T("+ Add Send Email action","jet-form-builder")))),(0,e.createElement)(S,{label:T("Success Page","jet-form-builder"),className:"control-flex"},(0,e.createElement)(x,{style:{flex:3.1},direction:"column"},-1!==d?(0,e.createElement)(e.Fragment,null,(0,e.createElement)(R,null,T("You have already configured the \nRedirect to Page action with the event:","jet-form-builder"),(0,e.createElement)("code",null,f)),(0,e.createElement)(x,null,(0,e.createElement)(k,{icon:(0,e.createElement)("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",width:"24",height:"24","aria-hidden":"true",focusable:"false"},(0,e.createElement)("path",{d:"m19 7-3-3-8.5 8.5-1 4 4-1L19 7Zm-7 11.5H5V20h7v-1.5Z"})),onClick:()=>{A({index:d,item:g})}},T("Edit verification success redirect","jet-form-builder")))):(0,e.createElement)(e.Fragment,null,(0,e.createElement)(B,{value:n.success_page,onChange:e=>t({success_page:e}),options:_,hideLabelFromVision:!0,onFilterValueChange:j}),(0,e.createElement)(R,{style:{marginTop:"-1em"}},T("Select a page for the redirect after successful \nverification. By default, the user is redirected to the form page. Or","jet-form-builder")," ",(0,e.createElement)(k,{isLink:!0,onClick:()=>{const e=G(n.success_page,f);A({index:r.length,item:{...e}})}},T("configure a separate Redirect to Page action","jet-form-builder")))))),(0,e.createElement)(S,{label:T("Failed Page","jet-form-builder"),className:"control-flex"},(0,e.createElement)(x,{style:{flex:3.1},direction:"column"},-1!==h?(0,e.createElement)(e.Fragment,null,(0,e.createElement)(R,null,T("You have already configured the\nRedirect to Page action with the event:","jet-form-builder"),(0,e.createElement)("code",null,p)),(0,e.createElement)(x,null,(0,e.createElement)(k,{icon:(0,e.createElement)("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",width:"24",height:"24","aria-hidden":"true",focusable:"false"},(0,e.createElement)("path",{d:"m19 7-3-3-8.5 8.5-1 4 4-1L19 7Zm-7 11.5H5V20h7v-1.5Z"})),onClick:()=>{A({index:h,item:E})}},T("Edit verification failed redirect","jet-form-builder")))):(0,e.createElement)(e.Fragment,null,(0,e.createElement)(B,{value:n.failed_page,onChange:e=>t({failed_page:e}),options:C,hideLabelFromVision:!0,onFilterValueChange:F}),(0,e.createElement)(R,{style:{marginTop:"-1em"}},T("Select a page for the redirect after verification \nfailure. By default, the user is redirected to the form page. Or","jet-form-builder")," ",(0,e.createElement)(k,{isLink:!0,onClick:()=>{const e=G(n.failed_page,p);A({index:r.length,item:{...e}})}},T("configure a separate Redirect to Page action","jet-form-builder")))))))},{TextControl:Y,BaseControl:Q,Button:K,Flex:X,SelectControl:$}=wp.components,{__:ee}=wp.i18n,{useState:te}=wp.element,{BaseHelp:ne,ActionModalHeaderSlotFill:ie}=JetFBComponents,{useLoopedAction:oe}=JetFBHooks,{EditActionSettingsButton:re,ActionItemWrapper:le,SelectActionsControl:ae,ActionItemMoreButton:ce}=JetFBComponents,{Flex:se,CardBody:ue}=wp.components,{select:me,dispatch:de}=wp.data;let fe;const pe=()=>{const e=me("core/editor").getEditedPostAttribute("meta")||{};if(fe===e._jf_actions||"string"!=typeof e._jf_actions)return;fe=e._jf_actions;const t=JSON.parse(fe),n=t.findIndex((({type:e})=>"verification"===e)),i=-1!==n,o=me("jet-forms/actions").getAction("verification");if(0<n&&i){const i=t[n];t.splice(n,1),de("core/editor").editPost({meta:{...e,_jf_actions:JSON.stringify([i,...t])}})}o.disabled!==i&&de("jet-forms/actions").editAction("verification",{disabled:i})},{BaseComputedField:he}=JetFBComponents,{sprintf:ge,__:ve}=wp.i18n;function Ee(){he.call(this),this.getSupportedActions=function(){return["register_user"]}}Ee.prototype=Object.create(he.prototype),Ee.prototype.getName=function(){return h},Ee.prototype.getLabel=function(){return ve("Secure unique token","jet-form-builder")},Ee.prototype.getHelp=function(){return ve("A computed field. Usually used to save it in the password fields","jet-form-builder")};const be=Ee;function we(){be.call(this),this.isSupported=function(e){var t;return"verification"===e.type&&!e.selfSettings.who_can||"register_user"===e.type&&Object.values(null!==(t=e.selfSettings.fields_map)&&void 0!==t?t:{}).includes(h)}}we.prototype=Object.create(be.prototype);const ye=we,{BaseComputedField:_e}=JetFBComponents,{sprintf:je,__:Ce}=wp.i18n;function Fe(){_e.call(this),this.getSupportedActions=function(){return["verification"]}}Fe.prototype=Object.create(_e.prototype),Fe.prototype.getName=function(){return"_jfb_verification_token_id"},Fe.prototype.getLabel=function(){return Ce("ID of secure unique token","jet-form-builder")},Fe.prototype.getHelp=function(){return Ce("A computed field from the Verification action.","jet-form-builder")};const Ae=Fe,{BaseComputedField:Se}=JetFBComponents,{__:Be}=wp.i18n;function ke(){Se.call(this),this.isSupported=function(e){return"verification"===e.type&&!e.selfSettings.who_can}}ke.prototype=Object.create(Se.prototype),ke.prototype.getName=function(){return"_jfb_verification_url"},ke.prototype.getLabel=function(){return Be("Verification URL","jet-form-builder")},ke.prototype.getHelp=function(){return Be("A computed field from the Verification action. \nUsually used to send it using the Send by Email action.","jet-form-builder")};const xe=ke,{useLoopedAction:Ie,useActionsEdit:Te,useActions:Oe,useEvents:Le}=JetFBHooks,{EditActionSettingsButton:Ve,EditActionConditionsButton:Je,ActionItemWrapper:Ne,SelectActionsControl:Re,ActionItemMoreButton:Pe,ActionItemDetails:He}=JetFBComponents,{Flex:De,CardBody:Me,CardFooter:Ue,Button:ze}=wp.components,{__:Ge}=wp.i18n,{addFilter:Ze}=wp.hooks,{addAction:qe,addComputedField:We}=JetFBActions,{subscribe:Ye,dispatch:Qe}=wp.data;window.JetFBComponents={...window.JetFBComponents,TokenComputedField:be,TokenIDComputedField:Ae,VerificationURLComputedField:xe},qe(d,(function({onChangeSettingObj:t,settings:n}){var i,o;const[r,l]=te(!1);return(0,e.createElement)(e.Fragment,null,(0,e.createElement)(ie.Fill,null,(0,e.createElement)(X,{gap:1},ee("Edit Verification action","jet-form-builder"),(0,e.createElement)(K,{variant:"tertiary",isPressed:r,icon:(0,e.createElement)("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",width:"24",height:"24","aria-hidden":"true",focusable:"false"},(0,e.createElement)("path",{d:"M12 4.75a7.25 7.25 0 100 14.5 7.25 7.25 0 000-14.5zM3.25 12a8.75 8.75 0 1117.5 0 8.75 8.75 0 01-17.5 0zM12 8.75a1.5 1.5 0 01.167 2.99c-.465.052-.917.44-.917 1.01V14h1.5v-.845A3 3 0 109 10.25h1.5a1.5 1.5 0 011.5-1.5zM11.25 15v1.5h1.5V15h-1.5z"})),onClick:()=>l((e=>!e))}))),r&&(0,e.createElement)(m,null),(0,e.createElement)($,{label:ee("Who can verify the submission","jet-form-builder"),value:null!==(i=n.who_can)&&void 0!==i?i:"",labelPosition:"side",options:[{value:"",label:ee("User & Administrator","jet-form-builder")},{value:"admin",label:ee("Administrator","jet-form-builder")}],onChange:e=>t({who_can:e})}),(0,e.createElement)(Q,{label:ee("Link Lifespan","jet-form-builder"),className:"jet-fb label-reset-margin"},(0,e.createElement)("div",{style:{flex:3}},(0,e.createElement)(Y,{value:null!==(o=n.lifespan)&&void 0!==o?o:4,onChange:e=>t({lifespan:e})}),(0,e.createElement)(ne,{style:{marginTop:"-4px"}},ee('Indicates for how many hours a verification link \nwill be active. If you leave this field empty or enter "0", it means \nverification can be completed at any given time.',"jet-form-builder")))),(0,e.createElement)(W,{settings:n,onChangeSettingObj:t}))})),We(be,{isScoped:!0}),We(ye),We(Ae),We(xe),Ze("jet.fb.register.plugin.jf-actions-panel.before","jet-form-builder/verification",(function(e){return e.push(s),e})),Ze("jet.fb.action.item","jet-form-builder/verification-action",(t=>()=>{const{action:n}=oe();return"verification"!==n.type?(0,e.createElement)(t,null):(0,e.createElement)(le,null,(0,e.createElement)(ue,null,(0,e.createElement)("div",null,(0,e.createElement)(ae,null)),(0,e.createElement)(se,{style:{marginTop:"0.5em"},justify:"space-between"},(0,e.createElement)(re,null),(0,e.createElement)(ce,{exclude:["up","down","off-on"]}))))})),Ze("jet.fb.action.item","jet-form-builder/footer-notice-for-no-events",(t=>()=>{const{action:n}=Ie(),{updateActionObj:i}=Te(),[o]=Oe(),r=Le(n),l=o.some((e=>"verification"===e.type));return n?.events?.length||"verification"===n.type||!l||1>=r.length?(0,e.createElement)(t,null):(0,e.createElement)(Ne,null,(0,e.createElement)(Me,null,(0,e.createElement)("div",null,(0,e.createElement)(Re,null)),(0,e.createElement)(De,{style:{marginTop:"0.5em"},justify:"space-between"},(0,e.createElement)(Ve,null),(0,e.createElement)(Je,null),(0,e.createElement)(Pe,null),(0,e.createElement)(He,null))),(0,e.createElement)(Ue,null,(0,e.createElement)(De,{justify:"flex-start",style:{width:"auto"}},(0,e.createElement)("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"-2 -2 24 24",width:"24",height:"24","aria-hidden":"true",focusable:"false",style:{color:"var( --wp-components-color-accent-darker-10, #9e1313 )"}},(0,e.createElement)("path",{fill:"currentColor",d:"M10 2c4.42 0 8 3.58 8 8s-3.58 8-8 8-8-3.58-8-8 3.58-8 8-8zm1.13 9.38l.35-6.46H8.52l.35 6.46h2.26zm-.09 3.36c.24-.23.37-.55.37-.96 0-.42-.12-.74-.36-.97s-.59-.35-1.06-.35-.82.12-1.07.35-.37.55-.37.97c0 .41.13.73.38.96.26.23.61.34 1.06.34s.8-.11 1.05-.34z"})),Ge("Runs on verification","jet-form-builder")),(0,e.createElement)(ze,{isLink:!0,onClick:()=>i(n.id,{events:["DEFAULT.PROCESS"]}),style:{textDecoration:"none",borderBottom:"2px dotted var(--wp-components-color-accent, var(--wp-admin-theme-color, #3858e9))"}},Ge("Run always","jet-form-builder"))))})),Ye((()=>setTimeout(pe,0))),Qe("jet-forms/actions").editAction(d,{provideEvents:()=>[f,p]})})();