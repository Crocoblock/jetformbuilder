(()=>{"use strict";const e=window.React,{__:t}=wp.i18n,{useMemo:n}=wp.element,{Button:i,Tooltip:o}=wp.components,{useActionsEdit:r}=JetFBHooks,{ActionsAfterNewButtonSlotFill:a}=JetFBComponents,{Tools:l}=JetFBActions,c=()=>({id:l.getRandomID(),type:"verification",settings:{}}),s={base:{jfbApiVersion:2,name:"jf-verification"},settings:{render:function(){const{actions:l,setActions:s}=r(),d=n(c,[]),u=l.some((({type:e})=>"verification"===e));return(0,e.createElement)(a.Fill,null,(0,e.createElement)(o,{text:t(u?"You have already added the Verification action":"Click here to add Verification action","jet-form-builder"),delay:200,position:"top center"},(0,e.createElement)(i,{onClick:()=>{s([{...d},...l])},disabled:u,variant:"tertiary"},t("+ Verification","jet-form-builder"))))},icon:"filter"}},{select:d,dispatch:u}=wp.data;let m;const f=()=>{const e=d("core/editor").getEditedPostAttribute("meta")||{};if(m===e._jf_actions||"string"!=typeof e._jf_actions)return;m=e._jf_actions;const t=JSON.parse(m),n=t.findIndex((({type:e})=>"verification"===e)),i=-1!==n,o=d("jet-forms/actions").getAction("verification");if(0<n&&i){const i=t[n];t.splice(n,1),u("core/editor").editPost({meta:{...e,_jf_actions:JSON.stringify([i,...t])}})}o.disabled!==i&&u("jet-forms/actions").editAction("verification",{disabled:i})},p="VERIFICATION.SUCCESS",h="VERIFICATION.FAILED",g="_jfb_verification_token",{BaseComputedField:v}=JetFBComponents,{sprintf:b,__:w}=wp.i18n;function E(){v.call(this),this.getSupportedActions=function(){return["register_user"]}}E.prototype=Object.create(v.prototype),E.prototype.getName=function(){return g},E.prototype.getLabel=function(){return w("Secure unique token","jet-form-builder")},E.prototype.getHelp=function(){return w("A computed field. Usually used to save it in the password fields","jet-form-builder")};const _=E;function y(){_.call(this),this.isSupported=function(e){var t;return"verification"===e.type&&!e.selfSettings.who_can||"register_user"===e.type&&Object.values(null!==(t=e.selfSettings.fields_map)&&void 0!==t?t:{}).includes(g)}}y.prototype=Object.create(_.prototype);const j=y,{BaseComputedField:C}=JetFBComponents,{sprintf:F,__:S}=wp.i18n;function A(){C.call(this),this.getSupportedActions=function(){return["verification"]}}A.prototype=Object.create(C.prototype),A.prototype.getName=function(){return"_jfb_verification_token_id"},A.prototype.getLabel=function(){return S("ID of secure unique token","jet-form-builder")},A.prototype.getHelp=function(){return S("A computed field from the Verification action.","jet-form-builder")};const k=A,{BaseComputedField:B}=JetFBComponents,{__:x}=wp.i18n;function I(){B.call(this),this.isSupported=function(e){return"verification"===e.type&&!e.selfSettings.who_can}}I.prototype=Object.create(B.prototype),I.prototype.getName=function(){return"_jfb_verification_url"},I.prototype.getLabel=function(){return x("Verification URL","jet-form-builder")},I.prototype.getHelp=function(){return x("A computed field from the Verification action. \nUsually used to send it using the Send by Email action.","jet-form-builder")};const T=I,O=window.wp.components,V=window.wp.i18n,{useLoopedAction:L,useActionsEdit:R,useActions:J,useEvents:N}=JetFBHooks,{ActionItemWrapper:H,ActionItemBody:P}=JetFBComponents,M=window.wp.hooks,D=window.wp.data,{__:U}=wp.i18n,z=function(){return(0,e.createElement)(e.Fragment,null,(0,e.createElement)("h3",{style:{marginTop:0}},U("Here is a brief description of how this verification action works:","jet-form-builder")),(0,e.createElement)("p",null,U("1. The user sends the form for the first time. \nOn this stage, all actions that having the","jet-form-builder")+" ",(0,e.createElement)("code",null,"DEFAULT.PROCESS")," "+U("event are executed. \nAfter that, Save Record action is executed, even if it is not present \nin the list of actions. At the same time, a unique token in a hashed \nform is stored in a separate table in the database.","jet-form-builder")),(0,e.createElement)("p",null,U("2. The user receives an email containing a link to your \nsite with a key to the previously saved token. This can be achieved by sending \na letter to e-mail.","jet-form-builder")),(0,e.createElement)("p",null,U("3. After clicking the link, the plugin checks the key with \nthe token. If the result is positive, the actions with either no events \nor with the","jet-form-builder")+" ",(0,e.createElement)("code",null,"VERIFICATION.SUCCESS")," "+U("event are executed. If the result is negative, only actions with the","jet-form-builder")+" ",(0,e.createElement)("code",null,"VERIFICATION.FAILED")," "+U("event will run.","jet-form-builder")))},{apiFetch:G}=wp,Z=async function(e){return(await G(e)).map((({title:e,id:t})=>({value:t,label:e.rendered})))},{addQueryArgs:q}=wp.url,{useState:Y,useEffect:Q}=wp.element,W=function(e=[]){const[t,n]=Y([]),[i,o]=Y("");return Q((()=>{var t;i?Z({path:(t=i,q("/wp/v2/pages",{search:t}))}).then(n):n(e)}),[i,e.length]),[t,o]},K=JSON.parse('[{"type":"send_email","settings":{"mail_to":"form","from_field":"_verify_user_email","subject":"[%CT::SiteName%] Confirm your email","content":"Please confirm your registration on site %CT::SiteName%.\\n\\n<b>If this was a mistake, ignore this email and nothing will happen.</b>\\n\\nTo complete the registration click on the link:\\n%_jfb_verification_url%"},"events":["DEFAULT.PROCESS"]}]');let{__experimentalToggleGroupControl:X,__experimentalToggleGroupControlOption:$,ToggleGroupControl:ee,ToggleGroupControlOption:te,BaseControl:ne,ComboboxControl:ie,Button:oe,Flex:re,SelectControl:ae}=wp.components;ee=ee||X,te=te||$;const{__:le}=wp.i18n,{useState:ce,useEffect:se,useMemo:de}=wp.element,{addQueryArgs:ue}=wp.url,{useDispatch:me}=wp.data,{BaseHelp:fe,BaseAction:pe,ToggleControl:he}=JetFBComponents,{useActions:ge,useFields:ve,useCurrentAction:be}=JetFBHooks,{Tools:we,convertFlow:Ee}=JetFBActions,_e=Ee(K),ye=(e,t)=>{const n=new Set(e.map((({value:e})=>e))),i=[];for(const e of t)n.has(e.value)||i.push(e);return[...e,...i]},je=function({onChangeSettingObj:t,settings:n}){var i,o;const[r,a]=ge([]),l=ve({withInner:!1},[]),{currentAction:c}=be(),s=de((()=>l.find((e=>"email"===e?.attributes?.field_type))),[]),[d,u]=ce(Boolean(n.mail_to)),m=de((()=>r.findIndex((({events:e=[],type:t})=>-1!==e.indexOf(p)&&"redirect_to_page"===t))),[]),f=de((()=>r.findIndex((({events:e=[],type:t})=>-1!==e.indexOf(h)&&"redirect_to_page"===t))),[]),g=null!==(i=r[m])&&void 0!==i?i:{},v=null!==(o=r[f])&&void 0!==o?o:{},[b,w]=ce([]),[E,_]=W(b),[y,j]=W(b),{openActionSettings:C}=me("jet-forms/actions"),F=(e,t)=>{const n=new pe({type:"redirect_to_page"});return n.events=[t],e&&(n.selfSettings={redirect_type:"static_page",redirect_page:e}),a([...r.map((e=>c.id!==e.id?e:c)),n]),n};return se((()=>{Z({path:"/wp/v2/pages"}).then((e=>w((t=>ye(t,e)))));const e=[n.success_page,n.failed_page].filter(Boolean);e.length&&Z({path:ue("/wp/v2/pages",{include:e})}).then((e=>w((t=>ye(t,e)))))}),[]),"admin"===n.who_can?null:(0,e.createElement)(e.Fragment,null,(0,e.createElement)(ne,{label:le("Email Field","jet-form-builder"),className:"jet-fb label-reset-margin"},(0,e.createElement)("div",{className:"jet-control-clear-full"},(0,e.createElement)(ae,{value:n.mail_to,onChange:e=>t({mail_to:e}),options:we.withPlaceholder(l),hideLabelFromVision:!0}),(0,e.createElement)(fe,null,le("Send a verification link to the email address \nprovided in this field.","jet-form-builder")),!d&&Boolean(s)&&(0,e.createElement)(fe,null,(0,e.createElement)(re,{justify:"flex-start",gap:1},le("(Suggestion) Choose the:","jet-form-builder"),(0,e.createElement)(oe,{isLink:!0,onClick:()=>{u(!0),t({mail_to:s.value})}},s.label),le("field","jet-form-builder"))))),n.mail_to&&(0,e.createElement)(he,{checked:Boolean(n.custom_email),onChange:e=>t({custom_email:e}),help:le("If disabled, a standard verification email will be sent. \nIf enabled, you can create a custom verification email \nwith a separate Send Email action.","jet-form-builder")},(0,e.createElement)(re,{gap:3,justify:"flex-start"},le("Create custom verification email","jet-form-builder"),n.custom_email&&(0,e.createElement)(oe,{isLink:!0,onClick:()=>{const e=(()=>{const{list:[e]}=_e;return e.selfSettings={...e.selfSettings,from_field:n.mail_to},a([...r.map((e=>c.id!==e.id?e:c)),{...e}]),e})();C({index:r.length,item:e})}},le("+ Add Send Email action","jet-form-builder")))),(0,e.createElement)(ne,{label:le("Success Page","jet-form-builder"),className:"control-flex"},(0,e.createElement)(re,{style:{flex:3.1},direction:"column"},-1!==m?(0,e.createElement)(e.Fragment,null,(0,e.createElement)(fe,null,le("You have already configured the \nRedirect to Page action with the event:","jet-form-builder"),(0,e.createElement)("code",null,p)),(0,e.createElement)(re,null,(0,e.createElement)(oe,{icon:(0,e.createElement)("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",width:"24",height:"24","aria-hidden":"true",focusable:"false"},(0,e.createElement)("path",{d:"m19 7-3-3-8.5 8.5-1 4 4-1L19 7Zm-7 11.5H5V20h7v-1.5Z"})),onClick:()=>{C({index:m,item:g})}},le("Edit verification success redirect","jet-form-builder")))):(0,e.createElement)(e.Fragment,null,(0,e.createElement)(ie,{value:n.success_page,onChange:e=>t({success_page:e}),options:E,hideLabelFromVision:!0,onFilterValueChange:_}),(0,e.createElement)(fe,{style:{marginTop:"-1em"}},le("Select a page for the redirect after successful \nverification. By default, the user is redirected to the form page. Or","jet-form-builder"),"Â ",(0,e.createElement)(oe,{isLink:!0,onClick:()=>{const e=F(n.success_page,p);C({index:r.length,item:{...e}})}},le("configure a separate Redirect to Page action","jet-form-builder")))))),(0,e.createElement)(ne,{label:le("Failed Page","jet-form-builder"),className:"control-flex"},(0,e.createElement)(re,{style:{flex:3.1},direction:"column"},-1!==f?(0,e.createElement)(e.Fragment,null,(0,e.createElement)(fe,null,le("You have already configured the\nRedirect to Page action with the event:","jet-form-builder"),(0,e.createElement)("code",null,h)),(0,e.createElement)(re,null,(0,e.createElement)(oe,{icon:(0,e.createElement)("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",width:"24",height:"24","aria-hidden":"true",focusable:"false"},(0,e.createElement)("path",{d:"m19 7-3-3-8.5 8.5-1 4 4-1L19 7Zm-7 11.5H5V20h7v-1.5Z"})),onClick:()=>{C({index:f,item:v})}},le("Edit verification failed redirect","jet-form-builder")))):(0,e.createElement)(e.Fragment,null,(0,e.createElement)(ie,{value:n.failed_page,onChange:e=>t({failed_page:e}),options:y,hideLabelFromVision:!0,onFilterValueChange:j}),(0,e.createElement)(fe,{style:{marginTop:"-1em"}},le("Select a page for the redirect after verification \nfailure. By default, the user is redirected to the form page. Or","jet-form-builder"),"Â ",(0,e.createElement)(oe,{isLink:!0,onClick:()=>{const e=F(n.failed_page,h);C({index:r.length,item:{...e}})}},le("configure a separate Redirect to Page action","jet-form-builder")))))))},Ce=window.wp.element,{BaseHelp:Fe,ActionModalHeaderSlotFill:Se,ActionModalBackButton:Ae}=JetFBComponents,ke=window.wp.primitives,Be=(0,e.createElement)(ke.SVG,{viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg"},(0,e.createElement)(ke.Path,{d:"M9 13.5a1.5 1.5 0 100-3 1.5 1.5 0 000 3zM9 16a4.002 4.002 0 003.8-2.75H15V16h2.5v-2.75H19v-2.5h-6.2A4.002 4.002 0 005 12a4 4 0 004 4z",fillRule:"evenodd",clipRule:"evenodd"})),xe={type:"verification",edit:function({onChangeSettingObj:t,settings:n}){var i,o;const[r,a]=(0,Ce.useState)(!1);return(0,e.createElement)(e.Fragment,null,(0,e.createElement)(Se.Fill,null,(0,e.createElement)(O.Button,{variant:"tertiary",isPressed:r,icon:(0,e.createElement)("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",width:"24",height:"24","aria-hidden":"true",focusable:"false"},(0,e.createElement)("path",{d:"M12 4.75a7.25 7.25 0 100 14.5 7.25 7.25 0 000-14.5zM3.25 12a8.75 8.75 0 1117.5 0 8.75 8.75 0 01-17.5 0zM12 8.75a1.5 1.5 0 01.167 2.99c-.465.052-.917.44-.917 1.01V14h1.5v-.845A3 3 0 109 10.25h1.5a1.5 1.5 0 011.5-1.5zM11.25 15v1.5h1.5V15h-1.5z"})),onClick:()=>a((e=>!e))})),r&&(0,e.createElement)(z,null),(0,e.createElement)(O.SelectControl,{label:(0,V.__)("Who can verify the submission","jet-form-builder"),value:null!==(i=n.who_can)&&void 0!==i?i:"",labelPosition:"side",options:[{value:"",label:(0,V.__)("User & Administrator","jet-form-builder")},{value:"admin",label:(0,V.__)("Administrator","jet-form-builder")}],onChange:e=>t({who_can:e})}),(0,e.createElement)(O.BaseControl,{label:(0,V.__)("Link Lifespan","jet-form-builder"),className:"jet-fb label-reset-margin"},(0,e.createElement)("div",{style:{flex:3}},(0,e.createElement)(O.TextControl,{value:null!==(o=n.lifespan)&&void 0!==o?o:4,onChange:e=>t({lifespan:e})}),(0,e.createElement)(Fe,{style:{marginTop:"-4px"}},(0,V.__)('Indicates for how many hours a verification link \nwill be active. If you leave this field empty or enter "0", it means \nverification can be completed at any given time.',"jet-form-builder")))),(0,e.createElement)(je,{settings:n,onChangeSettingObj:t}))},label:(0,V.__)("Verification","jet-form-builder"),icon:Be,docHref:"https://jetformbuilder.com/features/email-verification/",provideEvents:()=>[p,h],fixed:!0,disableConditions:!0,category:"user"},{addComputedField:Ie}=JetFBActions;window.JetFBComponents={...window.JetFBComponents,TokenComputedField:_,TokenIDComputedField:k,VerificationURLComputedField:T},Ie(_,{isScoped:!0}),Ie(j),Ie(k),Ie(T),(0,M.addFilter)("jet.fb.register.plugin.jf-actions-panel.before","jet-form-builder/verification",(function(e){return e.push(s),e})),(0,M.addFilter)("jet.fb.action.item","jet-form-builder/footer-notice-for-no-events",(t=>()=>{const{action:n}=L(),{updateActionObj:i}=R(),[o]=J(),r=N(n),a=o.some((e=>"verification"===e.type));return n?.events?.length||"verification"===n.type||!a||1>=r.length?(0,e.createElement)(t,null):(0,e.createElement)(H,null,(0,e.createElement)(P,null),(0,e.createElement)(O.CardFooter,null,(0,e.createElement)(O.Flex,{justify:"flex-start",style:{width:"auto"}},(0,e.createElement)("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"-2 -2 24 24",width:"24",height:"24","aria-hidden":"true",focusable:"false",style:{color:"var( --wp-components-color-accent-darker-10, #9e1313 )"}},(0,e.createElement)("path",{fill:"currentColor",d:"M10 2c4.42 0 8 3.58 8 8s-3.58 8-8 8-8-3.58-8-8 3.58-8 8-8zm1.13 9.38l.35-6.46H8.52l.35 6.46h2.26zm-.09 3.36c.24-.23.37-.55.37-.96 0-.42-.12-.74-.36-.97s-.59-.35-1.06-.35-.82.12-1.07.35-.37.55-.37.97c0 .41.13.73.38.96.26.23.61.34 1.06.34s.8-.11 1.05-.34z"})),(0,V.__)("Runs on verification","jet-form-builder")),(0,e.createElement)(O.Button,{isLink:!0,onClick:()=>i(n.id,{events:["DEFAULT.PROCESS"]}),style:{textDecoration:"none",borderBottom:"2px dotted var(--wp-components-color-accent, var(--wp-admin-theme-color, #3858e9))"}},(0,V.__)("Run always","jet-form-builder"))))})),(0,D.subscribe)((()=>setTimeout(f,0))),(0,D.dispatch)("jet-forms/actions").registerAction(xe)})();