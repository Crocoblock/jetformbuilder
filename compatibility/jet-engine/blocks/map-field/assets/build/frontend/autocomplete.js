(()=>{"use strict";var t={n:e=>{var s=e&&e.__esModule?()=>e.default:()=>e;return t.d(s,{a:s}),s},d:(e,s)=>{for(var o in s)t.o(s,o)&&!t.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:s[o]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)};const e=window.wp.apiFetch;var s=t.n(e);const o=window.wp.url,{ReactiveVar:n,LoadingReactiveVar:r}=JetFormBuilderAbstract;function i(t){this.searchNode=t,this.controller=null,this.search=new n(""),this.search.make(),this.search.watch(this.onChangeSearch.bind(this)),this.response=new n(!1),this.response.make(),this.loading=new r,this.loading.make(),this.initEventListeners()}i.prototype.initEventListeners=function(){this.searchNode.addEventListener("input",(t=>{this.search.current=t.target.value}))},i.prototype.onChangeSearch=function(){if(this.abort(),this.searchNode.value!==this.search.current&&(this.searchNode.value=this.search.current),2>this.search.current?.length)return void this.loading.end();const t=(0,o.addQueryArgs)(JetMapFieldsSettings.apiAutocomplete,{query:this.search.current});this.loading.start(),s()({path:t,signal:this.controller.signal}).then((t=>{this.response.current={success:!!t.success,response:t},this.loading.end()})).catch((t=>{"AbortError"!==t.name&&(this.response.current={success:!1,response:t},this.loading.end())}))},i.prototype.abort=function(){this.controller?.abort?.(),this.controller=new AbortController};const a=i,{ReactiveVar:c}=JetFormBuilderAbstract;function h(t){this.listNode=t,this.selected=new c,this.selected.make(),this.initEventListeners()}h.prototype.createItem=function(t){const e=document.createElement("li");return e.textContent=t.label,e.tabIndex=0,e},h.prototype.setItems=function(t){this.listNode.innerHTML="";const e=t.map(this.createItem.bind(this));this.listNode.append(...e)},h.prototype.showList=function(){this.listNode.querySelector("li")&&this.listNode.classList.add("show")},h.prototype.hideList=function(){this.listNode.classList.remove("show")},h.prototype.onSelect=function(){this.listNode.querySelectorAll(".selected").forEach((function(t){t.classList.remove("selected")})),this.selected.current.classList.add("selected")},h.prototype.initEventListeners=function(){this.listNode.addEventListener("click",(t=>{"LI"===t.target.tagName&&(this.selected.current=t.target)})),this.listNode.addEventListener("keydown",(t=>{const e=document.activeElement;if("LI"===e.tagName&&e.parentNode===this.listNode)switch(t.key){case"ArrowDown":this.focusNextItem(e),t.preventDefault();break;case"ArrowUp":this.focusPreviousItem(e),t.preventDefault();break;case"Enter":this.selected.current=e,t.preventDefault()}})),this.selected.watch(this.onSelect.bind(this))},h.prototype.focusNextItem=function(t){const e=t.nextElementSibling;e&&e.focus()},h.prototype.focusPreviousItem=function(t){const e=t.previousElementSibling;e?e.focus():this.focusTopOutside()},h.prototype.focusTopOutside=function(){},h.prototype.focusFirstItem=function(){const t=this.listNode.querySelector("li");t&&t.focus()};const l=h;function p(t,e){this.searchInput=t,this.dropDown=e,this.getDropDown().selected.signals=[],this.getDropDown().selected.watch((()=>{this.searchInput.searchNode.value=this.getDropDown().selected.current.textContent,this.getDropDown().hideList()})),this.getDropDown().focusTopOutside=()=>{this.getSearchInput().searchNode.focus()},this.getSearchInput().searchNode.addEventListener("keydown",(t=>{"ArrowDown"===t.key&&(this.dropDown.focusFirstItem(),t.preventDefault())})),this.getSearchInput().searchNode.addEventListener("focus",(t=>{this.getDropDown().showList()})),this.getSearchInput().searchNode.addEventListener("blur",(t=>{t.relatedTarget?.parentElement!==this.getDropDown().listNode&&this.getDropDown().hideList()})),this.getDropDown().listNode.addEventListener("focusout",(t=>{t.relatedTarget!==this.getSearchInput().searchNode&&t.relatedTarget?.parentElement!==this.getDropDown().listNode&&this.getDropDown().hideList()}))}p.prototype.getDropDown=function(){return this.dropDown},p.prototype.getSearchInput=function(){return this.searchInput};const d=p;function u(t,e){d.call(this,t,e)}u.prototype=Object.create(d.prototype),u.prototype.initHooks=function(){this.getDropDown().selected.watch((()=>{const t=this.getDropDown().selected.current;t.dataset.lat&&t.dataset.lng?this.getMapInput().callable.setMarker({lat:t.dataset.lat,lng:t.dataset.lng}):this.geocodeSearch()})),this.getSearchInput().loading.watch((()=>{console.log(this.getSearchInput().loading.current),this.getLoaderNode().classList.toggle("show",this.getSearchInput().loading.current)})),this.getSearchInput().response.watch((()=>{const{current:t}=this.getSearchInput().response,e=t.success?t.response?.data:[{label:t.response.html}];this.getDropDown().setItems(e),this.getDropDown().showList()})),this.getDropDown().createItem=t=>{const e=l.prototype.createItem.call(this.dropDown,t);return e.classList.add("jet-fb-map-field__search-item"),"label"in t||(e.textContent=t.address,t?.lat&&t?.lng&&(e.dataset.lat=t.lat,e.dataset.lng=t.lng)),e},this.getMapInput().value.watch((()=>{this.getMapInput().value.current||(this.getSearchInput().search.current="",this.getDropDown().setItems([]))}))},u.prototype.setLoaderNode=function(t){this.loader=t},u.prototype.getLoaderNode=function(){return this.loader},u.prototype.setMapInput=function(t){this.input=t},u.prototype.getMapInput=function(){return this.input},u.prototype.geocodeSearch=function(){const t=(0,o.addQueryArgs)(JetMapFieldsSettings.apiLocation,{address:this.getSearchInput().search.current});s()({path:t}).then((t=>{t.success?this.getMapInput().callable.setMarker(t.data):window.alert(t.html)})).catch((function(t){console.error(t)}))};const g=u,{addAction:f}=JetPlugins.hooks;f("jet.fb.input.makeReactive","jet-form-builder/map-field-autocomplete",(function(t){if("map"!==t.inputType||!t.nodes?.[0]?.parentElement?.querySelector?.(".jet-fb-map-field__search"))return;const e=t.nodes[0].parentElement.querySelector(".jet-fb-map-field__search"),s=new l(e.querySelector(".jet-fb-map-field__search-list")),o=new a(e.querySelector('[type="text"]')),n=new g(o,s);n.setLoaderNode(e.querySelector(".jet-fb-map-field__search-loader")),n.setMapInput(t),n.initHooks()}))})();